groups:
  - name: url_shortener_alerts
    rules:
      # High Error Rate Alert
      - alert: HighErrorRate
        expr: |
          (
            rate(url_shortener_http_requests_total{status_code=~"5.."}[5m]) /
            rate(url_shortener_http_requests_total[5m])
          ) * 100 > 1
        for: 5m
        labels:
          severity: critical
          service: url-shortener
          component: api
        annotations:
          summary: "High error rate detected"
          description: |
            Error rate is {{ $value | humanizePercentage }} over the last 5 minutes.
            This exceeds the 1% threshold.
            
            Current error rate: {{ $value | humanizePercentage }}
            Threshold: 1%
            
            Check application logs and system health immediately.

      # High P99 Latency Alert
      - alert: HighP99Latency
        expr: |
          histogram_quantile(0.99, 
            rate(url_shortener_http_request_duration_seconds_bucket[5m])
          ) * 1000 > 200
        for: 10m
        labels:
          severity: warning
          service: url-shortener
          component: api
        annotations:
          summary: "High P99 latency detected"
          description: |
            P99 latency is {{ $value | humanize }}ms over the last 10 minutes.
            This exceeds the 200ms threshold.
            
            Current P99 latency: {{ $value | humanize }}ms
            Threshold: 200ms
            
            Performance degradation detected. Check system resources and database performance.

      # Low Cache Hit Ratio Alert
      - alert: LowCacheHitRatio
        expr: url_shortener_cache_hit_ratio{cache_type="combined"} < 0.95
        for: 15m
        labels:
          severity: warning
          service: url-shortener
          component: cache
        annotations:
          summary: "Low cache hit ratio detected"
          description: |
            Combined cache hit ratio is {{ $value | humanizePercentage }} over the last 15 minutes.
            This is below the 95% threshold.
            
            Current hit ratio: {{ $value | humanizePercentage }}
            Threshold: 95%
            
            Cache performance is degraded. Check Redis health and memory usage.

      # Database Replication Lag Alert
      - alert: DatabaseReplicationLag
        expr: |
          (
            url_shortener_db_query_duration_seconds{operation="select", table="url_mappings"} -
            url_shortener_db_query_duration_seconds{operation="select", table="url_mappings"} offset 1m
          ) * 1000 > 10000
        for: 5m
        labels:
          severity: critical
          service: url-shortener
          component: database
        annotations:
          summary: "High database replication lag detected"
          description: |
            Database replication lag is {{ $value | humanize }}ms.
            This exceeds the 10 second threshold.
            
            Current lag: {{ $value | humanize }}ms
            Threshold: 10000ms (10 seconds)
            
            Database replication is falling behind. Check database health immediately.

      # High Memory Usage Alert
      - alert: HighMemoryUsage
        expr: |
          (
            url_shortener_process_resident_memory_bytes /
            url_shortener_process_virtual_memory_max_bytes
          ) * 100 > 85
        for: 10m
        labels:
          severity: warning
          service: url-shortener
          component: system
        annotations:
          summary: "High memory usage detected"
          description: |
            Memory usage is {{ $value | humanizePercentage }} over the last 10 minutes.
            This exceeds the 85% threshold.
            
            Current memory usage: {{ $value | humanizePercentage }}
            Threshold: 85%
            
            System memory usage is high. Consider scaling or investigating memory leaks.

      # High CPU Usage Alert
      - alert: HighCPUUsage
        expr: |
          rate(url_shortener_process_cpu_seconds_total[5m]) * 100 > 80
        for: 10m
        labels:
          severity: warning
          service: url-shortener
          component: system
        annotations:
          summary: "High CPU usage detected"
          description: |
            CPU usage is {{ $value | humanizePercentage }} over the last 10 minutes.
            This exceeds the 80% threshold.
            
            Current CPU usage: {{ $value | humanizePercentage }}
            Threshold: 80%
            
            System CPU usage is high. Check for performance bottlenecks.

      # Service Down Alert
      - alert: ServiceDown
        expr: up{job="url-shortener"} == 0
        for: 1m
        labels:
          severity: critical
          service: url-shortener
          component: api
        annotations:
          summary: "URL Shortener service is down"
          description: |
            The URL Shortener service has been down for more than 1 minute.
            
            Service: {{ $labels.instance }}
            Job: {{ $labels.job }}
            
            Immediate attention required. Check service health and logs.

      # High Request Rate Alert
      - alert: HighRequestRate
        expr: |
          rate(url_shortener_http_requests_total[5m]) > 10000
        for: 5m
        labels:
          severity: warning
          service: url-shortener
          component: api
        annotations:
          summary: "High request rate detected"
          description: |
            Request rate is {{ $value | humanize }} requests/second over the last 5 minutes.
            This exceeds the expected threshold of 10,000 requests/second.
            
            Current rate: {{ $value | humanize }} req/s
            Threshold: 10,000 req/s
            
            Traffic spike detected. Monitor system performance and consider scaling.

      # Database Connection Pool Exhaustion Alert
      - alert: DatabaseConnectionPoolExhaustion
        expr: url_shortener_db_connections_active > 80
        for: 5m
        labels:
          severity: critical
          service: url-shortener
          component: database
        annotations:
          summary: "Database connection pool near exhaustion"
          description: |
            Active database connections: {{ $value }}
            This is approaching the connection pool limit.
            
            Current connections: {{ $value }}
            Typical limit: ~100 connections
            
            Database connection pool is nearly exhausted. Check for connection leaks.

      # Redis Connection Issues Alert
      - alert: RedisConnectionIssues
        expr: |
          rate(url_shortener_cache_operations_total{cache_type="redis", status="error"}[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          service: url-shortener
          component: cache
        annotations:
          summary: "Redis connection issues detected"
          description: |
            Redis error rate is {{ $value | humanize }} errors/second over the last 5 minutes.
            
            Current error rate: {{ $value | humanize }} errors/s
            
            Redis connectivity issues detected. Check Redis cluster health.

      # Analytics Processing Lag Alert
      - alert: AnalyticsProcessingLag
        expr: |
          rate(url_shortener_analytics_events_total{status="error"}[5m]) /
          rate(url_shortener_analytics_events_total[5m]) > 0.05
        for: 10m
        labels:
          severity: warning
          service: url-shortener
          component: analytics
        annotations:
          summary: "Analytics processing errors detected"
          description: |
            Analytics error rate is {{ $value | humanizePercentage }} over the last 10 minutes.
            This exceeds the 5% threshold.
            
            Current error rate: {{ $value | humanizePercentage }}
            Threshold: 5%
            
            Analytics processing is experiencing issues. Check Kafka and processing pipeline.

  - name: url_shortener_business_alerts
    rules:
      # Unusual Traffic Pattern Alert
      - alert: UnusualTrafficPattern
        expr: |
          (
            rate(url_shortener_url_redirect_total[1h]) /
            rate(url_shortener_url_redirect_total[1h] offset 24h)
          ) > 5 or
          (
            rate(url_shortener_url_redirect_total[1h]) /
            rate(url_shortener_url_redirect_total[1h] offset 24h)
          ) < 0.2
        for: 30m
        labels:
          severity: warning
          service: url-shortener
          component: business
        annotations:
          summary: "Unusual traffic pattern detected"
          description: |
            Traffic pattern is significantly different from the same time yesterday.
            
            Current vs yesterday ratio: {{ $value }}
            
            This could indicate a traffic spike, DDoS attack, or service issue.

      # Low URL Creation Rate Alert
      - alert: LowURLCreationRate
        expr: |
          rate(url_shortener_url_creation_total[1h]) < 10
        for: 2h
        labels:
          severity: info
          service: url-shortener
          component: business
        annotations:
          summary: "Low URL creation rate"
          description: |
            URL creation rate is {{ $value | humanize }} URLs/hour over the last 2 hours.
            This is below the expected minimum of 10 URLs/hour.
            
            Current rate: {{ $value | humanize }} URLs/hour
            Expected minimum: 10 URLs/hour
            
            This might indicate reduced user activity or service issues.

      # High 404 Rate Alert
      - alert: High404Rate
        expr: |
          (
            rate(url_shortener_url_redirect_total{status="404"}[15m]) /
            rate(url_shortener_url_redirect_total[15m])
          ) * 100 > 10
        for: 15m
        labels:
          severity: warning
          service: url-shortener
          component: business
        annotations:
          summary: "High 404 rate detected"
          description: |
            404 error rate is {{ $value | humanizePercentage }} over the last 15 minutes.
            This exceeds the 10% threshold.
            
            Current 404 rate: {{ $value | humanizePercentage }}
            Threshold: 10%
            
            High rate of invalid short URL accesses detected. Check for broken links or attacks.