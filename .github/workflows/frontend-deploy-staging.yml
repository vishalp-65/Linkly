name: Deploy Frontend to Staging

on:
  push:
    branches:
      - develop
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-deploy-staging.yml'
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual deployment'
        required: false
        default: 'Manual deployment'

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://${{ secrets.STAGING_CLOUDFRONT_DOMAIN }}
    
    defaults:
      run:
        working-directory: frontend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        run: npm run test
      
      - name: Build for staging
        run: npm run build:staging
        env:
          NODE_ENV: staging
          VITE_BASE_URL: ${{ secrets.STAGING_API_URL }}
          VITE_REDIRECT_BASE_URL: ${{ secrets.STAGING_REDIRECT_URL }}
          VITE_WS_URL: ${{ secrets.STAGING_WS_URL }}
          VITE_ENABLE_CACHE: true
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Deploy to S3
        run: |
          # Upload HTML files with no-cache
          aws s3 sync dist/ s3://${{ secrets.STAGING_S3_BUCKET }}/ \
            --exclude "*" \
            --include "*.html" \
            --cache-control "no-cache, no-store, must-revalidate" \
            --metadata-directive REPLACE \
            --delete
          
          # Upload JS/CSS files with long cache
          aws s3 sync dist/ s3://${{ secrets.STAGING_S3_BUCKET }}/ \
            --exclude "*.html" \
            --include "*.js" \
            --include "*.css" \
            --cache-control "public, max-age=31536000, immutable" \
            --metadata-directive REPLACE \
            --delete
          
          # Upload other assets with moderate cache
          aws s3 sync dist/ s3://${{ secrets.STAGING_S3_BUCKET }}/ \
            --exclude "*.html" \
            --exclude "*.js" \
            --exclude "*.css" \
            --cache-control "public, max-age=86400" \
            --metadata-directive REPLACE \
            --delete
      
      - name: Invalidate CloudFront cache
        run: |
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.STAGING_CLOUDFRONT_DIST_ID }} \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          
          echo "CloudFront invalidation created: $INVALIDATION_ID"
          echo "invalidation_id=$INVALIDATION_ID" >> $GITHUB_OUTPUT
        id: invalidation
      
      - name: Wait for invalidation to complete
        run: |
          aws cloudfront wait invalidation-completed \
            --distribution-id ${{ secrets.STAGING_CLOUDFRONT_DIST_ID }} \
            --id ${{ steps.invalidation.outputs.invalidation_id }}
      
      - name: Verify deployment
        run: |
          echo "Deployment complete!"
          echo "Staging URL: https://${{ secrets.STAGING_CLOUDFRONT_DOMAIN }}"
          
          # Test if the site is accessible
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://${{ secrets.STAGING_CLOUDFRONT_DOMAIN }})
          if [ $HTTP_STATUS -eq 200 ]; then
            echo "✅ Site is accessible (HTTP $HTTP_STATUS)"
          else
            echo "❌ Site returned HTTP $HTTP_STATUS"
            exit 1
          fi
      
      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Staging deployment successful"
          else
            echo "❌ Staging deployment failed"
          fi
